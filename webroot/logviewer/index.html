<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Centralized Log Viewer</title>
    <base href="/logviewer/"/>
    <!-- Bootstrap 5 -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <style>
        /* Dark Theme Base */
        body {
            background-color: #1e1e1e;
            color: #f8f9fa;
        }

        .bg-dark-panel {
            background-color: #2a2a2a;
        }

        .sidebar {
            min-height: 100vh;
            border-right: 1px solid #444;
        }

        .card-dark {
            background-color: #2a2a2a;
            border: 1px solid #3a3a3a;
        }

        .card-dark .card-header {
            border-bottom: 1px solid #3a3a3a;
        }

        .text-secondary-light {
            color: #ced4da;
        }

        /* Log level colors */
        .log-error {
            color: #ff5252;
        }

        .log-warn {
            color: #ffc107;
        }

        .log-info {
            color: #0dcaf0;
        }

        .log-debug {
            color: #adb5bd;
        }

        /* Pagination override */
        .pagination .page-link {
            background-color: #2a2a2a;
            color: #f8f9fa;
            border: 1px solid #444;
        }

        .pagination .page-item.active .page-link {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
        }

        /* Log entry styling */
        .log-entry {
            border-bottom: 1px solid #444;
            padding: 8px 0;
        }

        .log-entry:hover {
            background-color: #343a40;
            cursor: pointer;
        }

        .btn-chevron {
            font-size: 1.8rem; /* Bigger icon */
            line-height: 1; /* Keep it tight */
            color: #0dcaf0;
            background: none;
            border: none;
            float: right;
            padding: 0;
            margin: 0;
            height: 100%; /* Fill the row height */
            display: flex;
            align-items: center; /* Vertically center */
            justify-content: center;
            text-decoration: none;
        }


        .btn-chevron:hover {
            color: #0dcaf0;
            opacity: 0.8;
            text-decoration: none;
        }

        .nav-tabs .nav-link {
            color: #0dcaf0 !important;
        }

        .nav-tabs .nav-link.active {
            background-color: #1e1e1e;
            border-color: #0dcaf0;
            color: #0dcaf0 !important;
        }

        #logDetails,
        #logDetails *,
        #details .card-header {
            color: #0dcaf0 !important;
        }

        #list .card-header,
        #list .card-body,
        #list .card-body * {
            color: #0dcaf0 !important;
        }

        #logStats,
        #logStats *,
        #stats .card-header {
            color: #0dcaf0 !important;
        }

        .log-details {
            display: none;
            background-color: #3a3a3a;
            padding: 10px;
            border-radius: 4px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar for Filters -->
        <nav
                id="sidebarMenu"
                class="col-12 col-md-3 col-lg-2 d-md-block sidebar bg-dark-panel p-3"
        >
            <h4>Filters</h4>
            <div class="mb-3">
                <label for="serverFilter" class="form-label">Server</label>
                <select id="serverFilter" class="form-select bg-dark-panel text-light">
                    <option value="">All Servers</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="levelFilter" class="form-label">Log Level</label>
                <select id="levelFilter" class="form-select bg-dark-panel text-light">
                    <option value="">All Levels</option>
                    <option value="info">Info</option>
                    <option value="warn">Warning</option>
                    <option value="error">Error</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="messageFilter" class="form-label">Message Contains</label>
                <input
                        type="text"
                        id="messageFilter"
                        class="form-control bg-dark-panel text-light"
                        placeholder="Filter by message..."
                />
            </div>
            <div class="mb-3">
                <label for="requestIdFilter" class="form-label">Request ID</label>
                <input
                        type="text"
                        id="requestIdFilter"
                        class="form-control bg-dark-panel text-light"
                        placeholder="Request ID"
                />
            </div>
            <div class="mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input
                        type="datetime-local"
                        id="startDate"
                        class="form-control bg-dark-panel text-light"
                />
            </div>
            <div class="mb-3">
                <label for="endDate" class="form-label">End Date</label>
                <input
                        type="datetime-local"
                        id="endDate"
                        class="form-control bg-dark-panel text-light"
                />
            </div>
            <button id="applyFilters" class="btn btn-primary w-100 mb-2">
                Apply Filters
            </button>
            <button id="refreshLogs" class="btn btn-secondary w-100">
                Refresh
            </button>
        </nav>

        <!-- Main Content with Tabs -->
        <main class="col-12 col-md-9 col-lg-10 px-md-4">
            <div class="py-3">
                <h2>Centralized Log Viewer</h2>
            </div>
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="logViewerTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button
                            class="nav-link active"
                            id="list-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#list"
                            type="button"
                            role="tab"
                            aria-controls="list"
                            aria-selected="true"
                    >
                        List
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                            class="nav-link"
                            id="details-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#details"
                            type="button"
                            role="tab"
                            aria-controls="details"
                            aria-selected="false"
                    >
                        Details
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button
                            class="nav-link"
                            id="stats-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#stats"
                            type="button"
                            role="tab"
                            aria-controls="stats"
                            aria-selected="false"
                    >
                        Stats
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content mt-3" id="logViewerTabContent">
                <!-- List Tab: Log Table -->
                <div
                        class="tab-pane fade show active"
                        id="list"
                        role="tabpanel"
                        aria-labelledby="list-tab"
                >
                    <div class="card card-dark">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-md-2"><strong>Timestamp</strong></div>
                                <div class="col-md-1"><strong>Level</strong></div>
                                <div class="col-md-2"><strong>Server</strong></div>
                                <div class="col-md-7"><strong>Message</strong></div>
                            </div>
                        </div>
                        <div class="card-body" id="logEntries">
                            <!-- Logs injected here -->
                        </div>
                    </div>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination" id="pagination"></ul>
                    </nav>
                </div>

                <!-- Details Tab: Selected Log Details -->
                <div
                        class="tab-pane fade"
                        id="details"
                        role="tabpanel"
                        aria-labelledby="details-tab"
                >
                    <div class="card card-dark">
                        <div class="card-header">
                            <h5>Log Details</h5>
                        </div>
                        <div class="card-body" id="logDetails">
                            <p class="text-secondary-light">
                                Select a log from the List tab to view its details.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Stats Tab: Log Statistics -->
                <div
                        class="tab-pane fade"
                        id="stats"
                        role="tabpanel"
                        aria-labelledby="stats-tab"
                >
                    <div class="card card-dark">
                        <div class="card-header">
                            <h5>Log Statistics</h5>
                        </div>
                        <div class="card-body" id="logStats">
                            <p>Loading statistics...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let currentPage = 1;
        let totalPages = 1;
        const itemsPerPage = 50;
        const logEntries = document.getElementById('logEntries');
        const pagination = document.getElementById('pagination');
        const serverFilter = document.getElementById('serverFilter');
        const levelFilter = document.getElementById('levelFilter');
        const messageFilter = document.getElementById('messageFilter');
        const requestIdFilter = document.getElementById('requestIdFilter');
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');
        const applyFilters = document.getElementById('applyFilters');
        const refreshLogs = document.getElementById('refreshLogs');

        // Initial load
        loadServers();
        loadLogs();
        loadStats();

        // Event listeners for filters and refresh
        applyFilters.addEventListener('click', () => {
            currentPage = 1;
            loadLogs();
        });
        refreshLogs.addEventListener('click', () => {
            loadLogs();
            loadStats();
        });

        // Fetch available servers from API
        async function loadServers() {
            try {
                // First try to get nodes from the cluster API (note the leading slash)
                const response = await fetch('/api/nodes/names');
                console.log('Fetching server names from: /api/nodes/names');

                if (response.ok) {
                    const nodes = await response.json();
                    console.log('Received nodes:', nodes);

                    serverFilter.innerHTML = '<option value="">All Servers</option>';
                    nodes.forEach(node => {
                        const option = document.createElement('option');
                        option.value = node;
                        option.textContent = node;
                        serverFilter.appendChild(option);
                    });

                    console.log('Server filter populated with node names');
                } else {
                    console.warn('Failed to get nodes, status:', response.status);
                    console.log('Trying fallback to server list...');

                    // Fallback to getting servers from logs collection (note the leading slash)
                    const fallbackResponse = await fetch('/api/servers');

                    if (fallbackResponse.ok) {
                        const servers = await fallbackResponse.json();
                        console.log('Received servers:', servers);

                        serverFilter.innerHTML = '<option value="">All Servers</option>';
                        servers.forEach(server => {
                            const option = document.createElement('option');
                            option.value = server;
                            option.textContent = server;
                            serverFilter.appendChild(option);
                        });

                        console.log('Server filter populated with server IDs');
                    } else {
                        console.error('Fallback server fetch failed, status:', fallbackResponse.status);
                        serverFilter.innerHTML = '<option value="">All Servers</option>';
                    }
                }
            } catch (error) {
                console.error('Error loading servers:', error);

                // Try fallback if first attempt fails (note the leading slash)
                try {
                    console.log('Trying final fallback attempt...');
                    const fallbackResponse = await fetch('/api/servers');

                    if (fallbackResponse.ok) {
                        const servers = await fallbackResponse.json();
                        console.log('Received servers in fallback:', servers);

                        serverFilter.innerHTML = '<option value="">All Servers</option>';
                        servers.forEach(server => {
                            const option = document.createElement('option');
                            option.value = server;
                            option.textContent = server;
                            serverFilter.appendChild(option);
                        });

                        console.log('Server filter populated in fallback');
                    } else {
                        console.error('Final fallback failed, status:', fallbackResponse.status);
                        serverFilter.innerHTML = '<option value="">All Servers (No servers found)</option>';
                    }
                } catch (fallbackError) {
                    console.error('Error in fallback server loading:', fallbackError);
                    serverFilter.innerHTML = '<option value="">All Servers (Error loading)</option>';
                }
            }
        }

        // Fetch logs using applied filters
        async function loadLogs() {
            try {
                // Display loading indicator
                logEntries.innerHTML = '<div class="text-center"><div class="spinner-border text-light" role="status"></div><p>Loading logs...</p></div>';

                const params = new URLSearchParams();
                params.append('page', currentPage);
                params.append('limit', itemsPerPage);

                if (serverFilter.value) {
                    params.append('serverId', serverFilter.value);
                    console.log(`Filtering by server: ${serverFilter.value}`);
                }

                if (levelFilter.value) params.append('level', levelFilter.value);
                if (messageFilter.value) params.append('message', messageFilter.value);
                if (requestIdFilter.value) params.append('requestId', requestIdFilter.value);

                // Format dates properly
                if (startDate.value) {
                    const startDateObj = new Date(startDate.value);
                    params.append('startDate', startDateObj.toISOString());
                }

                if (endDate.value) {
                    const endDateObj = new Date(endDate.value);
                    params.append('endDate', endDateObj.toISOString());
                }

                console.log('Fetching logs with params:', params.toString());
                // Note the leading slash in the URL
                const response = await fetch(`/api/logs?${params.toString()}`);

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const data = await response.json();
                console.log('Received log data:', data);

                totalPages = Math.max(1, data.pagination.pages);
                renderPagination();

                if (data.logs && data.logs.length > 0) {
                    renderLogs(data.logs);
                } else {
                    logEntries.innerHTML = '<div class="alert alert-info">No logs found matching your criteria.</div>';
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                logEntries.innerHTML = `<div class="alert alert-danger">Error loading logs: ${error.message}</div>`;
            }
        }

        // Render the log entries in the List tab
        function renderLogs(logs) {
            logEntries.innerHTML = '';

            if (!logs || logs.length === 0) {
                logEntries.innerHTML = '<div class="alert alert-info">No logs found.</div>';
                return;
            }

            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${log.level}`;
                const logTime = new Date(log.timestamp).toLocaleString();

                // Use our helper function to extract server name
                const serverName = extractServerName(log);

                // Extract request ID consistently
                const reqId = log.requestId || (log.metadata && log.metadata.requestId) || '';

                logEntry.innerHTML = `
            <div class="row">
                <div class="col-md-2"><span class="timestamp">${logTime}</span></div>
                <div class="col-md-1">${log.level.toUpperCase()}</div>
                <div class="col-md-2">${sanitizeHTML(serverName)}</div>
                <div class="col-md-7">
                    ${sanitizeHTML(log.message)}
                    ${reqId ? `<small class="text-muted ms-2">(${sanitizeHTML(reqId)})</small>` : ''}
                    <button class="btn btn-chevron view-details">&rsaquo;</button>
                </div>
            </div>
            <div class="log-details">
                <pre>${sanitizeHTML(JSON.stringify(log, null, 2))}</pre>
            </div>
        `;

                // Show log details when the chevron is clicked
                const detailsButton = logEntry.querySelector('.view-details');
                const detailsPanel = logEntry.querySelector('.log-details');

                detailsButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent the whole log entry from being clicked

                    if (detailsPanel.style.display === 'block') {
                        detailsPanel.style.display = 'none';
                        detailsButton.innerHTML = '&rsaquo;';
                    } else {
                        detailsPanel.style.display = 'block';
                        detailsButton.innerHTML = '&lsaquo;';
                    }
                });

                logEntry.addEventListener('click', () => {
                    updateDetailsTab(log);
                });

                logEntries.appendChild(logEntry);
            });
        }

        // Render pagination controls based on current page
        function renderPagination() {
            pagination.innerHTML = '';
            // Previous Button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            const prevLink = document.createElement('a');
            prevLink.className = 'page-link';
            prevLink.href = '#';
            prevLink.textContent = 'Previous';
            prevLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    loadLogs();
                }
            });
            prevLi.appendChild(prevLink);
            pagination.appendChild(prevLi);
            // Page Numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                const pageLink = document.createElement('a');
                pageLink.className = 'page-link';
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    loadLogs();
                });
                pageLi.appendChild(pageLink);
                pagination.appendChild(pageLi);
            }
            // Next Button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            const nextLink = document.createElement('a');
            nextLink.className = 'page-link';
            nextLink.href = '#';
            nextLink.textContent = 'Next';
            nextLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    loadLogs();
                }
            });
            nextLi.appendChild(nextLink);
            pagination.appendChild(nextLi);
        }

        // Fetch and display log statistics in the Stats tab
        async function loadStats() {
            try {
                // Note the leading slash in the URL
                const response = await fetch('/api/stats');

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const stats = await response.json();
                console.log('Received stats data:', stats);

                const logStats = document.getElementById('logStats');
                logStats.innerHTML = `
            <p>Total Logs: ${stats.totalLogs || 0}</p>
            <p>Error Logs: ${stats.errorCount || 0}</p>
            <p>Warning Logs: ${stats.warnCount || 0}</p>
            <p>Info Logs: ${stats.infoCount || 0}</p>
            <p>Unique Servers: ${stats.serverCount || 0}</p>
        `;
            } catch (error) {
                console.error('Error loading stats:', error);
                const logStats = document.getElementById('logStats');
                logStats.innerHTML = `<div class="alert alert-danger">Error loading statistics: ${error.message}</div>`;
            }
        }

        function extractServerName(log) {
            // Check all possible locations for server identification
            if (log.serverId) {
                return log.serverId;
            } else if (log.metadata && log.metadata.serverId) {
                return log.metadata.serverId;
            } else if (log.metadata && log.metadata.metadata && log.metadata.metadata.serverId) {
                return log.metadata.metadata.serverId;
            } else if (log.hostname) {
                return log.hostname;
            } else if (log.metadata && log.metadata.hostname) {
                return log.metadata.hostname;
            } else {
                return 'Unknown';
            }
        }

        // Update the Details tab with the selected log's details
        function updateDetailsTab(log) {
            const logDetails = document.getElementById('logDetails');
            logDetails.innerHTML = `
                <pre>${sanitizeHTML(JSON.stringify(log, null, 2))}</pre>
            `;
            // Programmatically switch to the Details tab
            const detailsTab = new bootstrap.Tab(document.getElementById('details-tab'));
            detailsTab.show();
        }

        // Simple HTML sanitization to prevent XSS (for demonstration purposes)
        function sanitizeHTML(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }
    });
</script>
</body>
</html>
